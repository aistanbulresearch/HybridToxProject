# Beyond Deep Learning Dominance: A Scaffold-Aware Hybrid Framework for Robust Toxicity Prediction

![Paper Status](https://img.shields.io/badge/Status-Under_Review-yellow.svg)
[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/drive/1KfO0dgz_pjtEo2pWLDgEGO8wPFHGXxNH)
[![Powered by RDKit](https://img.shields.io/badge/Powered%20by-RDKit-3838ff.svg)](https://www.rdkit.org/)
[![License: MIT](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

> **Official Repository for the Paper:** *"Beyond Deep Learning Dominance: A Scaffold-Aware Hybrid Framework for Robust Toxicity Prediction in Data-Scarce Regimes"*

## Overview

Computational toxicology faces a reliability crisis: deep learning models, despite their power, are prone to **"silent failures"** on out-of-distribution (OOD) data. This repository implements a **"Safe-by-Design" AI framework** that addresses this bottleneck in data-scarce regimes.

Instead of relying on a single "black-box" algorithm, we propose a **Hybrid Mixture of Experts (MoE)** architecture that manages epistemic uncertainty by integrating explicit structural memory with topological intuition.

---

## Theoretical Foundation: The "Tripartite Challenge"

This framework is engineered to solve three specific theoretical limitations in QSAR modeling, as detailed in our manuscript:

1.  **Validating against Prospective Difficulty (Sheridan et al.):** * We enforce a strict **Nested Scaffold Split**.
    * *Metric:* Unlike random splits ($T_c > 0.80$), our test set maintains a mean Tanimoto similarity of **0.44** to the training set, proving true OOD evaluation.
2.  **Navigating Activity Cliffs (Maggiora et al.):**
    * Deep learning often smooths over sharp discontinuities. We utilize **Random Forests** as "Activity Cliff Detectors," where a single bit-flip in a fingerprint can alter the decision path.
3.  **Mitigating Over-Smoothing (Chen et al.):**
    * Deep GNNs can "wash out" fine-grained features (e.g., steric constraints in Ligand Binding Domains). Our hybrid approach prevents this by explicitly retaining discrete chemical features.

---

## The Architecture

Our **Mixture of Experts (MoE)** meta-learner arbitrates between two complementary inductive biases:

### 1. The "Specific Guard" (Random Forest)
* **Role:** Explicit Memory & Precision.
* **Mechanism:** Uses 2048-bit Morgan Fingerprints to identify known toxicophores.
* **Function:** Acts as a conservative filter, pruning hallucinations (False Positives) generated by the GNN.

### 2. The "Sensitive Scout" (Advanced GNN)
* **Role:** Topological Intuition & Recall.
* **Mechanism:** A custom Graph Convolutional Network (GCN) designed to capture global reactivity patterns.
* **Function:** Detects toxicity in novel scaffolds where explicit substructure matches are absent.

### 3. The Meta-Learner (Logistic Stacking)
* **Role:** Reliability Arbitration.
* **Mechanism:** Dynamically weights the experts based on the validation set performance, pivoting to the most robust model for the specific task.

---

## Key Results & Robustness

Evaluated across **12 Tox21 endpoints** using a 5-seed average protocol:

* **Fail-Safe Mechanism:** In the *NR-AR-LBD* task, where the pure GNN collapsed (AUC 0.634) due to signal over-smoothing, the Hybrid MoE recovered performance to **0.746**, surpassing the SOTA baseline.
* **Statistical Equivalence:** Achieved global performance statistically equivalent ($p > 0.05$) to the industry-standard **DeepChem GraphConv** model.
* **The "Safety Cost" (Minimax Principle):** While we observe minor negative transfer in structurally homogeneous tasks (e.g., *NR-PPAR-gamma*), this is accepted as a calculated cost to ensure **prevention of catastrophic failure** in complex, high-risk endpoints.

---

## Getting Started

### Prerequisites
* Python 3.8+
* PyTorch
* DeepChem
* RDKit
* Scikit-Learn

### Quick Start with Google Colab
The easiest way to reproduce our results and visualize the "Scout vs. Guard" behavior is via our interactive notebook:

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/drive/1KfO0dgz_pjtEo2pWLDgEGO8wPFHGXxNH)

### Dataset
The project utilizes the **Tox21 Data Challenge** dataset. The preprocessing pipeline (included in the notebook) performs:
1.  Salt Stripping & Solvent Removal
2.  Canonicalization (RDKit, `includeChirality=False`)
3.  Deduplication & Inconclusive label removal

---

## Repository Structure
```text
HybridToxProject/
│
├── data/
│   ├── train_internal.csv
│   ├── validation.csv
│   └── test_external.csv
│
├── results/
│   ├── grand_slam_results_full.csv  
│   ├── final_stats.pkl
│   └── final_experiment_data.pkl
│
├── figures/
│   ├── Figure_Schematic.png
│   ├── Figure1_Performance.png
│   ├── Figure2_Correlation.png
│   ├── Figure3_Metrics.png
│   └── Figure4_CaseStudy.png
│
├── README.md  
└── main_notebook.ipynb
```


## Citation

If you use this code or framework in your research, please cite our paper (BibTeX pending publication):

```bibtex
@article{HybridTox2025,
  title={Beyond Deep Learning Dominance: A Scaffold-Aware Hybrid Framework for Robust Toxicity Prediction in Data-Scarce Regimes},
  author={Cavus, Ozge A. and Kuskucu, Aysegul},
  journal={Submitted for Publication},
  year={2025}
}
```

## Acknowledgments 
We thank the Tox21 Data Challenge organizers, RDKit and the DeepChem development team. Computing resources were provided by Google Colab.
